---
title: "Gateway API"
date: 2020-09-13T17:33:04+01:00
weight: 20
summary: "Ingress proxy routing"
---

Ingress & Gateway API


Top -> Down 

|Hierarchy | Description
|--------------|---|
| Gateway Class | |
| Gateway | |
| *Route | |
| Service | |


https://gateway-api.sigs.k8s.io/


```
make gateway-setup
```

```
$ make gateway-check
pod/istio-ingressgateway-574dff7b88-9cd7v condition met
pod/istiod-59db6b6d9-pl6np condition met
pod/metallb-controller-748756655f-zqdxn condition met
pod/metallb-speaker-97tb7 condition met
pod/metallb-speaker-pwvrx condition met
pod/metallb-speaker-qln9k condition met
```

```
$ make deployment && make cluster-ip
```

```
$ kubectl get -n istio-system gateways gateway -o jsonpath='{.status.addresses}' | jq
[
  {
    "type": "IPAddress",
    "value": "198.51.100.0"
  }
]
```

```
$ docker exec k8s-guide-control-plane curl -s -HHost:gateway.tkng.io http://198.51.100.0/ | grep Welcome
<title>Welcome to nginx!</title>
<h1>Welcome to nginx!</h1>
 ```

```
$ istioctl proxy-status
NAME                                                   CDS        LDS        EDS        RDS        ISTIOD                     VERSION
istio-ingressgateway-574dff7b88-tnqck.istio-system     SYNCED     SYNCED     SYNCED     SYNCED     istiod-59db6b6d9-j8kt8     1.12-alpha.2a768472737998f0e13cfbfec74162005c53300c
```

```
$ istioctl proxy-config listener istio-ingressgateway-574dff7b88-tnqck.istio-system
ADDRESS PORT  MATCH DESTINATION
0.0.0.0 8080  ALL   Route: http.8080
0.0.0.0 15021 ALL   Inline Route: /healthz/ready*
0.0.0.0 15090 ALL   Inline Route: /stats/prometheus*
```

```
$ istioctl proxy-config route istio-ingressgateway-574dff7b88-tnqck.istio-system --name http.8080 -ojson
[
    {
        "name": "http.8080",
        "virtualHosts": [
            {
                "name": "gateway.tkng.io:80",
                "domains": [
                    "gateway.tkng.io",
                    "gateway.tkng.io:*"
                ],
                "routes": [
                    {
                        "match": {
                            "prefix": "/",
                            "caseSensitive": true
                        },
                        "route": {
                            "cluster": "outbound|80||web.default.svc.cluster.local",
                            "timeout": "0s",
                            "retryPolicy": {
                                "retryOn": "connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes",
                                "numRetries": 2,
                                "retryHostPredicate": [
                                    {
                                        "name": "envoy.retry_host_predicates.previous_hosts"
                                    }
                                ],
                                "hostSelectionRetryMaxAttempts": "5",
                                "retriableStatusCodes": [
                                    503
                                ]
                            },
                            "maxGrpcTimeout": "0s"
                        },
                        "metadata": {
                            "filterMetadata": {
                                "istio": {
                                    "config": "/apis/networking.istio.io/v1alpha3/namespaces/default/virtual-service/http-istio-autogenerated-k8s-gateway"
                                }
                            }
                        },
                        "decorator": {
                            "operation": "web.default.svc.cluster.local:80/*"
                        }
                    }
                ],
                "includeRequestAttemptCount": true
            }
        ],
        "validateClusters": false
    }
]
```


```
$ istioctl proxy-config endpoints istio-ingressgateway-574dff7b88-tnqck.istio-system  --cluster "outbound|80||web.default.svc.cluster.local"
ENDPOINT           STATUS      OUTLIER CHECK     CLUSTER
10.244.1.12:80     HEALTHY     OK                outbound|80||web.default.svc.cluster.local
```

```
$ kubectl get pod -owide -l app=web
NAME                  READY   STATUS    RESTARTS   AGE    IP            NODE               NOMINATED NODE   READINESS GATES
web-96d5df5c8-p8f97   1/1     Running   0          104m   10.244.1.12   k8s-guide-worker   <none>           <none>
```